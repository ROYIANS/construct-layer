# ã€Šæ„é€ å±‚ã€‹å­˜æ¡£ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ“‹ è®¾è®¡ç†å¿µ

æœ¬æ¸¸æˆé‡‡ç”¨**æ— ä¼ ç»Ÿèœå•**çš„æ²‰æµ¸å¼å­˜æ¡£ç³»ç»Ÿï¼Œç¬¦åˆOSæ¨¡æ‹Ÿçš„çœŸå®æ„Ÿã€‚

### æ ¸å¿ƒç‰¹ç‚¹
1. **è‡ªåŠ¨å­˜æ¡£**ï¼šå…³é”®èŠ‚ç‚¹è‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
2. **ç³»ç»Ÿè¿˜åŸç‚¹**ï¼šé€šè¿‡"ç³»ç»Ÿå±æ€§"é¢æ¿æ‰‹åŠ¨åˆ›å»ºï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
3. **Metaå­˜æ¡£**ï¼šå­˜æ¡£ä¿¡æ¯å¯è§†åŒ–ä¸ºæ¸¸æˆå†…æ–‡ä»¶ï¼ˆ`identity_log.txt`ï¼‰
4. **æ£€æŸ¥ç‚¹ç³»ç»Ÿ**ï¼šé‡è¦å‰§æƒ…èŠ‚ç‚¹è‡ªåŠ¨åˆ›å»ºæ£€æŸ¥ç‚¹

---

## ğŸ—‚ï¸ æŠ€æœ¯æ¶æ„

### å­˜å‚¨æ–¹æ¡ˆ
- **IndexedDB**ï¼šå­˜å‚¨å®Œæ•´çš„æ¸¸æˆçŠ¶æ€æ•°æ®
- **localStorage**ï¼šå¿«é€Ÿæ£€æµ‹æ˜¯å¦æœ‰å­˜æ¡£ï¼ˆç”¨äºä¸»èœå•ï¼‰

### æ ¸å¿ƒæ¨¡å—
```
src/
â”œâ”€â”€ systems/
â”‚   â””â”€â”€ SaveManager.ts          # å­˜æ¡£ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ useGameStore.ts         # æ¸¸æˆçŠ¶æ€å­˜å‚¨ï¼ˆé›†æˆå­˜æ¡£APIï¼‰
â””â”€â”€ types/
    â””â”€â”€ game.d.ts               # ç±»å‹å®šä¹‰
```

---

## ğŸ“¦ æ•°æ®ç»“æ„

### GameStateï¼ˆæ¸¸æˆçŠ¶æ€ï¼‰
```typescript
{
  currentChapter: number,           // å½“å‰ç« èŠ‚
  currentScene: string,             // å½“å‰åœºæ™¯ID
  flags: Record<string, boolean>,   // å‰§æƒ…æ ‡è®°
  variables: Record<string, any>,   // åŠ¨æ€å˜é‡
  playTime: number,                 // æ¸¸ç©æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  systemTime: string,               // æ¸¸æˆå†…ç³»ç»Ÿæ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  discoveredClues: string[],        // å·²å‘ç°çš„çº¿ç´¢
  readFiles: string[],              // å·²è¯»è¿‡çš„æ–‡ä»¶ID
  fileSystemState: any,             // æ–‡ä»¶ç³»ç»ŸçŠ¶æ€å¿«ç…§
  narrativeIndex: number,           // å½“å‰å¯¹è¯è¿›åº¦
  osState: {
    openWindows: string[],          // æ‰“å¼€çš„çª—å£
    desktopLayout: any,             // æ¡Œé¢å¸ƒå±€
    browserHistory: string[],       // æµè§ˆå™¨å†å²
    weChatMessages: any[]           // å¾®ä¿¡æ¶ˆæ¯çŠ¶æ€
  }
}
```

### SaveDataï¼ˆå­˜æ¡£æ•°æ®ï¼‰
```typescript
{
  id: string,                       // å­˜æ¡£IDï¼ˆå”¯ä¸€ï¼‰
  name: string,                     // å­˜æ¡£åç§°
  timestamp: Date,                  // ä¿å­˜æ—¶é—´
  thumbnail?: string,               // å­˜æ¡£æˆªå›¾ï¼ˆBase64ï¼‰
  chapterId: number,                // ç« èŠ‚ID
  sceneId: string,                  // åœºæ™¯ID
  gameState: GameState,             // å®Œæ•´æ¸¸æˆçŠ¶æ€
  metadata: {
    playTime: number,               // æ¸¸ç©æ—¶é•¿
    saveCount: number,              // å­˜æ¡£æ¬¡æ•°
    version: string,                // æ¸¸æˆç‰ˆæœ¬
    saveType: 'auto' | 'manual' | 'checkpoint',  // å­˜æ¡£ç±»å‹
    description?: string            // å­˜æ¡£æè¿°
  }
}
```

---

## ğŸ® ä½¿ç”¨æ–¹å¼

### 1. è‡ªåŠ¨å­˜æ¡£
åœ¨æ¸¸æˆè¿›ç¨‹ä¸­è‡ªåŠ¨è§¦å‘ï¼Œç©å®¶æ— éœ€æ“ä½œã€‚

```typescript
import { useGameStore } from '@/stores/useGameStore';

const { saveGame } = useGameStore();

// åœ¨å…³é”®æ“ä½œåè°ƒç”¨
await saveGame('auto'); // è‡ªåŠ¨å­˜æ¡£
```

**è§¦å‘æ¡ä»¶**ï¼š
- æ¯1åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥å¹¶ä¿å­˜
- æ‰“å¼€å…³é”®æ–‡ä»¶æ—¶
- å®Œæˆé‡è¦å¯¹è¯æ—¶
- å‘ç°é‡è¦çº¿ç´¢æ—¶

**å­˜æ¡£æ•°é‡é™åˆ¶**ï¼šæœ€å¤šä¿ç•™5ä¸ªè‡ªåŠ¨å­˜æ¡£ï¼Œæ—§çš„ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚

---

### 2. æ‰‹åŠ¨å­˜æ¡£ï¼ˆç³»ç»Ÿè¿˜åŸç‚¹ï¼‰
ç©å®¶é€šè¿‡æ¸¸æˆå†…çš„"ç³»ç»Ÿå±æ€§"é¢æ¿æ‰‹åŠ¨åˆ›å»ºã€‚

```typescript
await saveGame('manual', 'æˆ‘çš„å­˜æ¡£ç‚¹'); // æ‰‹åŠ¨å­˜æ¡£ï¼Œè‡ªå®šä¹‰åç§°
```

**æœªæ¥å®ç°**ï¼š
- å³é”®"æˆ‘çš„ç”µè„‘" â†’ "å±æ€§" â†’ "åˆ›å»ºç³»ç»Ÿè¿˜åŸç‚¹"
- å¼¹å‡ºå¯¹è¯æ¡†è¾“å…¥å­˜æ¡£åç§°
- åˆ›å»ºæ‰‹åŠ¨å­˜æ¡£

---

### 3. æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰
åœ¨å‰§æƒ…å…³é”®èŠ‚ç‚¹è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºé˜²æ­¢ç©å®¶å¡å…³ã€‚

```typescript
await createCheckpoint('å‘ç°ç¬¬ä¸€ä¸ªçº¿ç´¢'); // åˆ›å»ºæ£€æŸ¥ç‚¹
```

**è§¦å‘æ—¶æœº**ï¼š
- ç« èŠ‚å¼€å§‹
- Bosså¯¹è¯å‰
- é‡è¦é€‰æ‹©å‰
- è§£è°œå®Œæˆå

---

### 4. è¯»å–å­˜æ¡£
åœ¨ä¸»èœå•ç‚¹å‡»"ç»§ç»­æ¸¸æˆ"æ—¶è§¦å‘ã€‚

```typescript
const { loadGame } = useGameStore();

// åŠ è½½æœ€æ–°å­˜æ¡£
const latestSave = await saveManager.getLatestSave();
await loadGame(latestSave.id);

// æˆ–åŠ è½½æŒ‡å®šå­˜æ¡£
await loadGame('save_manual_1699999999999');
```

---

## ğŸ”„ å­˜æ¡£æµç¨‹

### ä¿å­˜æµç¨‹
```
1. ç”¨æˆ·æ“ä½œ / è‡ªåŠ¨è§¦å‘
   â†“
2. è·å–å½“å‰å®Œæ•´æ¸¸æˆçŠ¶æ€
   â†“
3. åˆ›å»º SaveData å¯¹è±¡
   â†“
4. å†™å…¥ IndexedDB
   â†“
5. æ›´æ–° localStorage æ ‡è®°
   â†“
6. å®Œæˆï¼ˆæ§åˆ¶å°æ—¥å¿—ï¼‰
```

### åŠ è½½æµç¨‹
```
1. ç”¨æˆ·ç‚¹å‡»"ç»§ç»­æ¸¸æˆ"
   â†“
2. ä» IndexedDB è¯»å–æœ€æ–°å­˜æ¡£
   â†“
3. æ¢å¤æ¸¸æˆçŠ¶æ€åˆ° Zustand Store
   â†“
4. æ ¹æ®åœºæ™¯IDè·³è½¬åˆ°å¯¹åº”åœºæ™¯
   â†“
5. å®Œæˆï¼ˆè¿›å…¥æ¸¸æˆï¼‰
```

---

## ğŸ› ï¸ API å‚è€ƒ

### SaveManager ç±»

#### `createSave(gameState, saveType, customName)`
åˆ›å»ºæ–°çš„å­˜æ¡£ã€‚

**å‚æ•°**ï¼š
- `gameState: GameState` - å½“å‰æ¸¸æˆçŠ¶æ€
- `saveType?: 'auto' | 'manual' | 'checkpoint'` - å­˜æ¡£ç±»å‹ï¼ˆé»˜è®¤ 'manual'ï¼‰
- `customName?: string` - è‡ªå®šä¹‰å­˜æ¡£åç§°

**è¿”å›**ï¼š`Promise<SaveData>`

---

#### `loadSave(saveId)`
åŠ è½½æŒ‡å®šIDçš„å­˜æ¡£ã€‚

**å‚æ•°**ï¼š
- `saveId: string` - å­˜æ¡£ID

**è¿”å›**ï¼š`Promise<GameState | null>`

---

#### `getLatestSave()`
è·å–æœ€æ–°çš„å­˜æ¡£ã€‚

**è¿”å›**ï¼š`Promise<SaveData | null>`

---

#### `getAllSaves()`
è·å–æ‰€æœ‰å­˜æ¡£åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰ã€‚

**è¿”å›**ï¼š`Promise<SaveData[]>`

---

#### `deleteSave(saveId)`
åˆ é™¤æŒ‡å®šå­˜æ¡£ã€‚

**å‚æ•°**ï¼š
- `saveId: string` - å­˜æ¡£ID

**è¿”å›**ï¼š`Promise<void>`

---

#### `hasSaves()`
æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨å­˜æ¡£ã€‚

**è¿”å›**ï¼š`Promise<boolean>`

---

#### `clearAllSaves()`
æ¸…é™¤æ‰€æœ‰å­˜æ¡£ï¼ˆå±é™©æ“ä½œï¼‰ã€‚

**è¿”å›**ï¼š`Promise<void>`

---

### useGameStore Hooks

#### `saveGame(saveType?, customName?)`
ä¿å­˜å½“å‰æ¸¸æˆã€‚

```typescript
const { saveGame } = useGameStore();
await saveGame('manual', 'å‘ç°çœŸç›¸å‰');
```

---

#### `loadGame(saveId)`
åŠ è½½æŒ‡å®šå­˜æ¡£ã€‚

```typescript
const { loadGame } = useGameStore();
await loadGame('save_auto_1699999999999');
```

---

#### `createCheckpoint(eventName)`
åˆ›å»ºæ£€æŸ¥ç‚¹ã€‚

```typescript
const { createCheckpoint } = useGameStore();
await createCheckpoint('ç¬¬ä¸€ç« å¼€å§‹');
```

---

#### `getCurrentState()`
è·å–å½“å‰å®Œæ•´æ¸¸æˆçŠ¶æ€ã€‚

```typescript
const { getCurrentState } = useGameStore();
const currentState = getCurrentState();
console.log(currentState);
```

---

## ğŸ“Œ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåœ¨å¯¹è¯å®Œæˆååˆ›å»ºæ£€æŸ¥ç‚¹
```typescript
const handleNarrativeComplete = async () => {
  await createCheckpoint('ç¬¬ä¸€ç« å¯¹è¯å®Œæˆ');
  setState('game');
};
```

### ç¤ºä¾‹2ï¼šåœ¨æ‰“å¼€å…³é”®æ–‡ä»¶æ—¶è‡ªåŠ¨å­˜æ¡£
```typescript
const handleOpenFile = async (fileId: string) => {
  if (isKeyFile(fileId)) {
    await saveGame('auto');
  }
  openFile(fileId);
};
```

### ç¤ºä¾‹3ï¼šåœ¨ä¸»èœå•ç»§ç»­æ¸¸æˆ
```typescript
const handleContinue = async () => {
  const latestSave = await saveManager.getLatestSave();
  if (latestSave) {
    await loadGame(latestSave.id);
    setState('game');
  }
};
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è‡ªåŠ¨å­˜æ¡£é™åˆ¶**ï¼šæœ€å¤šä¿ç•™5ä¸ªè‡ªåŠ¨å­˜æ¡£ï¼Œæ—§çš„ä¼šè¢«è¦†ç›–
2. **æµè§ˆå™¨å…¼å®¹æ€§**ï¼šéœ€è¦æ”¯æŒIndexedDBï¼ˆç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒï¼‰
3. **å­˜æ¡£å®‰å…¨**ï¼šç›®å‰æ²¡æœ‰åŠ å¯†ï¼Œæœªæ¥å¯è€ƒè™‘æ·»åŠ 
4. **è·¨è®¾å¤‡åŒæ­¥**ï¼šç›®å‰ä¸æ”¯æŒï¼Œæ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°

---

## ğŸ”® æœªæ¥è®¡åˆ’

- [ ] æ·»åŠ å­˜æ¡£æˆªå›¾åŠŸèƒ½
- [ ] å®ç°"ç³»ç»Ÿè¿˜åŸç‚¹"UIç•Œé¢
- [ ] æ”¯æŒäº‘å­˜æ¡£ï¼ˆå¯é€‰ï¼‰
- [ ] å­˜æ¡£åŠ å¯†
- [ ] å­˜æ¡£å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
- [ ] Metaå­˜æ¡£å¯è§†åŒ–ï¼ˆ`identity_log.txt` æ–‡ä»¶ï¼‰

---

**æœ€åæ›´æ–°**ï¼š2024-12-14
**ç‰ˆæœ¬**ï¼šv1.0.0
